# Liquibase Tutorial Docker Compose
# Creates 3 SQL Server containers (dev, stg, prd) for multi-environment tutorial
#
# Network Modes:
#   - Docker: Uses default bridge network (containers accessible via localhost:port)
#   - Podman: Use podman-compose with this file, or docker-compose.podman.yml for rootless
#
# IMPORTANT: Set LIQUIBASE_TUTORIAL_DATA_DIR before running:
#   export LIQUIBASE_TUTORIAL_DATA_DIR="/data/$USER/liquibase_tutorial"
# Or source the setup script: source scripts/setup_tutorial.sh
#
# Volume Mount Suffixes:
#   - :Z,U flags are used for SELinux/rootless Podman compatibility
#   - Docker ignores these flags, so they are safe for both runtimes
#   - :Z = Relabel volume for SELinux (private to this container)
#   - :U = Recursively change ownership to match container user

services:
  # ============================================================================
  # SQL Server Containers (one per environment)
  # ============================================================================
  
  mssql_dev:
    build:
      context: ../../../../docker/mssql
      dockerfile: Dockerfile
    image: mssql_tutorial:latest
    container_name: mssql_dev
    hostname: mssql_dev
    ports:
      - "${MSSQL_DEV_PORT:-14331}:1433"
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${MSSQL_LIQUIBASE_TUTORIAL_PWD:?MSSQL_LIQUIBASE_TUTORIAL_PWD is required}
      - MSSQL_PID=Developer
    volumes:
      - ${LIQUIBASE_TUTORIAL_DATA_DIR:-/data/liquibase_tutorial}/mssql_dev:/var/opt/mssql:Z,U
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P "$${MSSQL_SA_PASSWORD}" -Q "SELECT 1" -b -o /dev/null || exit 1
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 15s

  mssql_stg:
    build:
      context: ../../../../docker/mssql
      dockerfile: Dockerfile
    image: mssql_tutorial:latest
    container_name: mssql_stg
    hostname: mssql_stg
    ports:
      - "${MSSQL_STG_PORT:-14332}:1433"
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${MSSQL_LIQUIBASE_TUTORIAL_PWD:?MSSQL_LIQUIBASE_TUTORIAL_PWD is required}
      - MSSQL_PID=Developer
    volumes:
      - ${LIQUIBASE_TUTORIAL_DATA_DIR:-/data/liquibase_tutorial}/mssql_stg:/var/opt/mssql:Z,U
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P "$${MSSQL_SA_PASSWORD}" -Q "SELECT 1" -b -o /dev/null || exit 1
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 15s

  mssql_prd:
    build:
      context: ../../../../docker/mssql
      dockerfile: Dockerfile
    image: mssql_tutorial:latest
    container_name: mssql_prd
    hostname: mssql_prd
    ports:
      - "${MSSQL_PRD_PORT:-14333}:1433"
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${MSSQL_LIQUIBASE_TUTORIAL_PWD:?MSSQL_LIQUIBASE_TUTORIAL_PWD is required}
      - MSSQL_PID=Developer
    volumes:
      - ${LIQUIBASE_TUTORIAL_DATA_DIR:-/data/liquibase_tutorial}/mssql_prd:/var/opt/mssql:Z,U
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P "$${MSSQL_SA_PASSWORD}" -Q "SELECT 1" -b -o /dev/null || exit 1
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 15s

  # ============================================================================
  # Liquibase Service (run-once tool)
  # ============================================================================
  
  liquibase:
    build:
      context: ../../../../docker/liquibase
      dockerfile: Dockerfile
    image: liquibase:latest
    container_name: liquibase_tutorial
    working_dir: /data
    volumes:
      - ${LIQUIBASE_TUTORIAL_DATA_DIR:-/data/liquibase_tutorial}:/data:Z,U
    environment:
      - LIQUIBASE_LOG_LEVEL=INFO
    profiles:
      - tools
    restart: "no"

