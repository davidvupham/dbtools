# HashiCorp Vault Course - High Availability Cluster
#
# This configuration creates a 3-node Vault cluster using Raft storage.
# Used for Module 4 Track C (Operations) exercises.
#
# Usage:
#   docker compose -f docker-compose.ha.yml up -d
#   # Initialize vault-1 first, then join vault-2 and vault-3

services:
  vault-1:
    image: hashicorp/vault:1.15
    container_name: vault-1
    hostname: vault-1
    ports:
      - "8200:8200"
      - "8201:8201"
    environment:
      VAULT_ADDR: http://127.0.0.1:8200
      VAULT_API_ADDR: http://vault-1:8200
      VAULT_CLUSTER_ADDR: http://vault-1:8201
    volumes:
      - ./vault-config/vault-1.hcl:/vault/config/vault.hcl:ro
      - vault-1-data:/vault/data
    cap_add:
      - IPC_LOCK
    command: vault server -config=/vault/config/vault.hcl
    networks:
      - vault-cluster

  vault-2:
    image: hashicorp/vault:1.15
    container_name: vault-2
    hostname: vault-2
    ports:
      - "8202:8200"
      - "8203:8201"
    environment:
      VAULT_ADDR: http://127.0.0.1:8200
      VAULT_API_ADDR: http://vault-2:8200
      VAULT_CLUSTER_ADDR: http://vault-2:8201
    volumes:
      - ./vault-config/vault-2.hcl:/vault/config/vault.hcl:ro
      - vault-2-data:/vault/data
    cap_add:
      - IPC_LOCK
    command: vault server -config=/vault/config/vault.hcl
    depends_on:
      - vault-1
    networks:
      - vault-cluster

  vault-3:
    image: hashicorp/vault:1.15
    container_name: vault-3
    hostname: vault-3
    ports:
      - "8204:8200"
      - "8205:8201"
    environment:
      VAULT_ADDR: http://127.0.0.1:8200
      VAULT_API_ADDR: http://vault-3:8200
      VAULT_CLUSTER_ADDR: http://vault-3:8201
    volumes:
      - ./vault-config/vault-3.hcl:/vault/config/vault.hcl:ro
      - vault-3-data:/vault/data
    cap_add:
      - IPC_LOCK
    command: vault server -config=/vault/config/vault.hcl
    depends_on:
      - vault-1
    networks:
      - vault-cluster

  # PostgreSQL for database labs
  postgres:
    image: postgres:15-alpine
    container_name: vault-ha-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: appdb
    volumes:
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - postgres-ha-data:/var/lib/postgresql/data
    networks:
      - vault-cluster

networks:
  vault-cluster:
    driver: bridge

volumes:
  vault-1-data:
  vault-2-data:
  vault-3-data:
  postgres-ha-data:
