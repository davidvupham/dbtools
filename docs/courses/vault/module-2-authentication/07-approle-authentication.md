# AppRole Authentication

**[← Back to Module 2](./README.md)**

> **Document Version:** 1.0
> **Last Updated:** January 21, 2026
> **Maintainers:** Global Data Services Team
> **Status:** Production

![Status](https://img.shields.io/badge/Status-Production-green)
![Module](https://img.shields.io/badge/Module-2_Authentication-blue)
![Lesson](https://img.shields.io/badge/Lesson-07-purple)

## Learning objectives

By the end of this lesson, you will be able to:

- Explain when and why to use AppRole authentication
- Configure AppRole roles with appropriate security settings
- Implement secure secret ID delivery in CI/CD pipelines
- Troubleshoot common AppRole issues

## Table of contents

- [What is AppRole?](#what-is-approle)
- [AppRole concepts](#approle-concepts)
- [Configuring AppRole](#configuring-approle)
- [Authentication workflow](#authentication-workflow)
- [Security best practices](#security-best-practices)
- [CI/CD integration](#cicd-integration)
- [Hands-on lab](#hands-on-lab)
- [Key takeaways](#key-takeaways)

---

## What is AppRole?

AppRole is Vault's recommended authentication method for machines and applications. It uses a two-part credential system (role ID and secret ID) to authenticate.

### When to use AppRole

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      APPROLE USE CASES                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ✅ IDEAL FOR:                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │ • CI/CD pipelines (Jenkins, GitHub Actions, GitLab CI)         │   │
│   │ • Application servers (web apps, microservices)                │   │
│   │ • Batch jobs and cron tasks                                    │   │
│   │ • Containers (when not using K8s auth)                         │   │
│   │ • Any machine-to-machine authentication                        │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│   ❌ NOT IDEAL FOR:                                                     │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │ • Human users (use userpass, LDAP, or OIDC)                    │   │
│   │ • Kubernetes pods (use Kubernetes auth)                        │   │
│   │ • AWS EC2/Lambda (use AWS auth)                                │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### The two-part credential

| Component | Description | Analogy |
|-----------|-------------|---------|
| **Role ID** | Static identifier for the role | Username |
| **Secret ID** | Dynamic, short-lived credential | Password |

[↑ Back to Table of Contents](#table-of-contents)

---

## AppRole concepts

### Role configuration

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        APPROLE ROLE ANATOMY                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   Role: "myapp-prod"                                                    │
│   ─────────────────                                                      │
│   │                                                                      │
│   ├── Role ID (static)                                                  │
│   │   • Unique identifier: "abc123-def456-ghi789"                       │
│   │   • Generated by Vault                                              │
│   │   • Typically stored in application config                          │
│   │                                                                      │
│   ├── Secret ID Settings                                                │
│   │   • secret_id_ttl: 24h (how long secret IDs are valid)             │
│   │   • secret_id_num_uses: 1 (one-time use recommended)               │
│   │   • secret_id_bound_cidrs: ["10.0.0.0/8"] (IP restrictions)        │
│   │                                                                      │
│   ├── Token Settings                                                    │
│   │   • token_policies: ["myapp-secrets"]                              │
│   │   • token_ttl: 1h                                                  │
│   │   • token_max_ttl: 4h                                              │
│   │   • token_bound_cidrs: ["10.0.0.0/8"]                              │
│   │                                                                      │
│   └── Security Settings                                                 │
│       • bind_secret_id: true (require secret ID)                       │
│       • local_secret_ids: false                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Security levels

| Setting | Low Security | High Security |
|---------|--------------|---------------|
| `bind_secret_id` | false (role ID only) | true |
| `secret_id_num_uses` | 0 (unlimited) | 1 (one-time) |
| `secret_id_ttl` | Long (days) | Short (minutes) |
| `secret_id_bound_cidrs` | Not set | Restricted |
| `token_bound_cidrs` | Not set | Restricted |

[↑ Back to Table of Contents](#table-of-contents)

---

## Configuring AppRole

### Enable AppRole

```bash
# Enable the auth method
vault auth enable approle

# Verify it's enabled
vault auth list | grep approle
```

### Create a role

```bash
# Create a role for an application
vault write auth/approle/role/myapp \
    token_policies="myapp-secrets" \
    token_ttl=1h \
    token_max_ttl=4h \
    secret_id_ttl=24h \
    secret_id_num_uses=1
```

### Get role ID

```bash
# Role ID is static - retrieve once and store
vault read auth/approle/role/myapp/role-id

# Output:
# role_id    abc123-def456-ghi789
```

### Generate secret ID

```bash
# Generate a new secret ID
vault write -f auth/approle/role/myapp/secret-id

# Output:
# secret_id             xyz-secret-id-789
# secret_id_accessor    accessor-123
# secret_id_num_uses    1
# secret_id_ttl         24h
```

### Configure advanced settings

```bash
# High-security configuration
vault write auth/approle/role/myapp-prod \
    token_policies="myapp-prod-secrets" \
    token_ttl=20m \
    token_max_ttl=1h \
    secret_id_ttl=10m \
    secret_id_num_uses=1 \
    secret_id_bound_cidrs="10.0.0.0/8,192.168.1.0/24" \
    token_bound_cidrs="10.0.0.0/8"
```

[↑ Back to Table of Contents](#table-of-contents)

---

## Authentication workflow

### Standard flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    APPROLE AUTHENTICATION FLOW                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   SETUP PHASE (Admin)                                                   │
│   ──────────────────                                                     │
│                                                                          │
│   1. Admin creates role and policy                                      │
│      vault write auth/approle/role/myapp ...                            │
│                                                                          │
│   2. Admin retrieves Role ID                                            │
│      vault read auth/approle/role/myapp/role-id                         │
│      → Stores in application config or CI secrets                       │
│                                                                          │
│   RUNTIME PHASE (Application)                                           │
│   ───────────────────────────                                            │
│                                                                          │
│   3. Trusted orchestrator generates Secret ID                           │
│      vault write -f auth/approle/role/myapp/secret-id                   │
│      → Passes to application securely                                   │
│                                                                          │
│   4. Application authenticates                                          │
│      ┌─────────────┐                        ┌─────────────┐             │
│      │ Application │ ─── Role ID ─────────▶ │    Vault    │             │
│      │             │ ─── Secret ID ───────▶ │             │             │
│      │             │ ◀── Token ──────────── │             │             │
│      └─────────────┘                        └─────────────┘             │
│                                                                          │
│   5. Application uses token for operations                              │
│      vault kv get secret/myapp/config                                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Authentication API call

```bash
# Login with AppRole
vault write auth/approle/login \
    role_id="abc123-def456-ghi789" \
    secret_id="xyz-secret-id-789"

# Output:
# token           hvs.CAESIG...
# token_accessor  abc123
# token_duration  1h
# token_policies  ["default", "myapp-secrets"]
```

### Using curl

```bash
# Login via API
curl -s \
    -X POST \
    -d '{"role_id":"abc123","secret_id":"xyz789"}' \
    $VAULT_ADDR/v1/auth/approle/login | jq

# Extract token
TOKEN=$(curl -s \
    -X POST \
    -d '{"role_id":"abc123","secret_id":"xyz789"}' \
    $VAULT_ADDR/v1/auth/approle/login | jq -r '.auth.client_token')
```

[↑ Back to Table of Contents](#table-of-contents)

---

## Security best practices

### Secret ID management

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    SECRET ID BEST PRACTICES                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   DO:                                                                   │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │ ✅ Use one-time secret IDs (secret_id_num_uses=1)               │   │
│   │ ✅ Set short TTLs (minutes, not days)                           │   │
│   │ ✅ Bind to specific CIDRs when possible                         │   │
│   │ ✅ Generate secret IDs just-in-time                             │   │
│   │ ✅ Use response wrapping for delivery                           │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│   DON'T:                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │ ❌ Store secret IDs in source code                              │   │
│   │ ❌ Use unlimited-use secret IDs in production                   │   │
│   │ ❌ Share secret IDs across applications                         │   │
│   │ ❌ Use long TTLs for secret IDs                                 │   │
│   │ ❌ Log secret IDs                                               │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Response wrapping

Wrap secret IDs for secure delivery:

```bash
# Generate wrapped secret ID (valid for 120 seconds)
vault write -wrap-ttl=120s -f auth/approle/role/myapp/secret-id

# Output:
# wrapping_token:         hvs.CAES...
# wrapping_accessor:      abc123
# wrapping_token_ttl:     2m
# wrapping_token_creation_time: 2026-01-21T10:00:00.000Z

# Unwrap to get actual secret ID
vault unwrap hvs.CAES...
```

### CIDR binding

```bash
# Restrict where secret IDs can be generated from
vault write auth/approle/role/myapp \
    secret_id_bound_cidrs="10.0.0.0/8" \
    token_bound_cidrs="10.0.1.0/24"
```

[↑ Back to Table of Contents](#table-of-contents)

---

## CI/CD integration

### GitHub Actions example

```yaml
# .github/workflows/deploy.yml
name: Deploy with Vault

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Import Secrets
        uses: hashicorp/vault-action@v2
        with:
          url: https://vault.example.com
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            secret/data/myapp/config db_password | DB_PASSWORD ;
            secret/data/myapp/config api_key | API_KEY

      - name: Deploy
        run: |
          echo "Deploying with secrets..."
          # $DB_PASSWORD and $API_KEY are now available
```

### Jenkins pipeline

```groovy
// Jenkinsfile
pipeline {
    agent any

    environment {
        VAULT_ADDR = 'https://vault.example.com'
    }

    stages {
        stage('Get Secrets') {
            steps {
                withVault(
                    configuration: [
                        vaultUrl: env.VAULT_ADDR,
                        vaultCredentialId: 'vault-approle'
                    ],
                    vaultSecrets: [
                        [
                            path: 'secret/myapp/config',
                            secretValues: [
                                [envVar: 'DB_PASSWORD', vaultKey: 'db_password']
                            ]
                        ]
                    ]
                ) {
                    sh 'deploy.sh'
                }
            }
        }
    }
}
```

### Shell script pattern

```bash
#!/bin/bash
# ci-deploy.sh

# Role ID from CI secrets
ROLE_ID="${VAULT_ROLE_ID}"

# Secret ID generated just-in-time by trusted process
SECRET_ID="${VAULT_SECRET_ID}"

# Authenticate
TOKEN=$(curl -s \
    -X POST \
    -d "{\"role_id\":\"${ROLE_ID}\",\"secret_id\":\"${SECRET_ID}\"}" \
    ${VAULT_ADDR}/v1/auth/approle/login | jq -r '.auth.client_token')

# Use token
DB_PASSWORD=$(curl -s \
    -H "X-Vault-Token: ${TOKEN}" \
    ${VAULT_ADDR}/v1/secret/data/myapp/config | jq -r '.data.data.db_password')

# Deploy with secrets
deploy_application
```

[↑ Back to Table of Contents](#table-of-contents)

---

## Hands-on lab

### Setup

```bash
export VAULT_ADDR='http://127.0.0.1:8200'
export VAULT_TOKEN='root'
```

### Exercise 1: Basic AppRole setup

1. Enable AppRole:
   ```bash
   vault auth enable approle 2>/dev/null || echo "Already enabled"
   ```

2. Create a policy:
   ```bash
   vault policy write myapp-policy - <<EOF
   path "secret/data/myapp/*" {
     capabilities = ["read"]
   }
   EOF
   ```

3. Create a role:
   ```bash
   vault write auth/approle/role/myapp \
       token_policies="myapp-policy" \
       token_ttl=1h \
       secret_id_num_uses=1
   ```

4. Get role ID:
   ```bash
   ROLE_ID=$(vault read -format=json auth/approle/role/myapp/role-id | jq -r '.data.role_id')
   echo "Role ID: $ROLE_ID"
   ```

5. Generate secret ID:
   ```bash
   SECRET_ID=$(vault write -f -format=json auth/approle/role/myapp/secret-id | jq -r '.data.secret_id')
   echo "Secret ID: $SECRET_ID"
   ```

### Exercise 2: Authenticate with AppRole

1. Create a test secret:
   ```bash
   vault kv put secret/myapp/config db_password="mysecret"
   ```

2. Authenticate:
   ```bash
   APP_TOKEN=$(vault write -format=json auth/approle/login \
       role_id="$ROLE_ID" \
       secret_id="$SECRET_ID" | jq -r '.auth.client_token')
   echo "App Token: $APP_TOKEN"
   ```

3. Use the token:
   ```bash
   VAULT_TOKEN=$APP_TOKEN vault kv get secret/myapp/config
   ```

4. Try to use secret ID again (should fail):
   ```bash
   SECRET_ID2=$(vault write -f -format=json auth/approle/role/myapp/secret-id | jq -r '.data.secret_id')

   # Using old secret ID fails
   vault write auth/approle/login role_id="$ROLE_ID" secret_id="$SECRET_ID"
   # Error: invalid secret id
   ```

### Exercise 3: Response wrapping

1. Generate wrapped secret ID:
   ```bash
   WRAPPED=$(vault write -wrap-ttl=120s -f -format=json auth/approle/role/myapp/secret-id | jq -r '.wrap_info.token')
   echo "Wrapped token: $WRAPPED"
   ```

2. Unwrap it:
   ```bash
   SECRET_ID=$(vault unwrap -format=json $WRAPPED | jq -r '.data.secret_id')
   echo "Unwrapped Secret ID: $SECRET_ID"
   ```

3. Try to unwrap again (fails - one-time use):
   ```bash
   vault unwrap $WRAPPED
   # Error: wrapping token is not valid or does not exist
   ```

---

## Key takeaways

1. **AppRole is for machines** - Use it for applications, CI/CD, not humans

2. **Two-part credential** - Role ID (static) + Secret ID (dynamic)

3. **One-time secret IDs** - Use `secret_id_num_uses=1` in production

4. **Just-in-time generation** - Generate secret IDs right before use

5. **Response wrapping** - Secure delivery of secret IDs

6. **CIDR binding** - Restrict where credentials can be used from

7. **Short TTLs** - Minimize exposure window

---

## Next steps

In the next lesson, you'll learn about userpass and LDAP authentication for human users.

---

[← Previous: Token Authentication](./06-token-authentication.md) | [Back to Module 2](./README.md) | [Next: Userpass & LDAP →](./08-userpass-ldap-authentication.md)
