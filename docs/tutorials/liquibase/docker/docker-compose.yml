# SQL Server Docker Container for Liquibase Tutorial
# This container is dedicated to the Liquibase tutorial and can be safely removed after completing the tutorial

services:
  mssql_liquibase_tutorial:
    image: mcr.microsoft.com/mssql/server:2025-latest
    container_name: mssql_liquibase_tutorial
    hostname: mssql_liquibase_tutorial

    ports:
      - "${MSSQL_LIQUIBASE_TUTORIAL_PORT:-14333}:1433"

    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${MSSQL_LIQUIBASE_TUTORIAL_PWD}
      - MSSQL_PID=Developer

    volumes:
      - mssql_liquibase_tutorial_data:/var/opt/mssql

    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P "$${MSSQL_SA_PASSWORD}" -Q "SELECT 1" -b -o /dev/null
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s

    networks:
      - liquibase_tutorial

  github_runner:
    image: myoung34/github-runner:latest
    container_name: liquibase-tutorial-runner
    restart: unless-stopped

    environment:
      - RUNNER_NAME=${RUNNER_NAME:-liquibase-tutorial-runner}
      - RUNNER_WORKDIR=${RUNNER_WORKDIR:-/tmp/github-runner}
      - RUNNER_TOKEN=${RUNNER_TOKEN}
      - REPO_URL=${REPO_URL}
      - RUNNER_LABELS=${RUNNER_LABELS:-self-hosted,linux,x64,wsl,docker}
      - RUNNER_GROUP=${RUNNER_GROUP:-default}

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - github_runner_data:/tmp/github-runner

    depends_on:
      mssql_liquibase_tutorial:
        condition: service_healthy

    networks:
      - liquibase_tutorial

    profiles:
      - runner

volumes:
  mssql_liquibase_tutorial_data:
    name: mssql_liquibase_tutorial_data
  github_runner_data:
    name: github_runner_data

networks:
  liquibase_tutorial:
    name: liquibase_tutorial
    driver: bridge
