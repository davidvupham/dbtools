import sys
import os
import logging
import smtplib
from email.message import EmailMessage
from datetime import datetime, timezone
from croniter import croniter
import snowflake.connector

# --- Logging setup ---
script_name = os.path.splitext(os.path.basename(__file__))[0]
log_file = f"{script_name}.log"
logging.basicConfig(filename=log_file, level=logging.INFO,
                    format="%(asctime)s %(levelname)s %(message)s")

def log_error(msg):
    logging.error(msg)

def send_email(subject, body, to_email):
    # Configure SMTP details here
    smtp_server = "smtp.example.com"
    smtp_port = 587
    smtp_user = "user@example.com"
    smtp_password = "password"
    from_email = smtp_user

    msg = EmailMessage()
    msg.set_content(body)
    msg["Subject"] = subject
    msg["From"] = from_email
    msg["To"] = to_email

    try:
        with smtplib.SMTP(smtp_server, smtp_port) as server:
            server.starttls()
            server.login(smtp_user, smtp_password)
            server.send_message(msg)
        logging.info(f"Sent email to {to_email}: {subject}")
    except Exception as e:
        log_error(f"Failed to send email: {e}")

def connect_snowflake(account, user, password, role="ACCOUNTADMIN"):
    try:
        conn = snowflake.connector.connect(
            account=account,
            user=user,
            password=password,
            role=role
        )
        logging.info(f"Connected to Snowflake account: {account}")
        return conn
    except Exception as e:
        log_error(f"Failed to connect to Snowflake: {e}")
        sys.exit(1)

def get_failover_groups(conn):
    try:
        cur = conn.cursor()
        cur.execute("show failover groups")
        rows = cur.fetchall()
        # Columns: created_on, name, database_name, primary, secondary, schedule, next_refresh, last_refresh, last_refresh_status, last_refresh_duration
        groups = []
        for row in rows:
            group = {
                "name": row[1],
                "primary": row[3],
                "secondary": row[4],
                "schedule": row[5],
                "next_refresh": row[6],
                "last_refresh": row[7],
                "last_refresh_status": row[8],
                "last_refresh_duration": row[9]
            }
            groups.append(group)
        logging.info(f"Found {len(groups)} failover groups")
        return groups
    except Exception as e:
        log_error(f"Failed to get failover groups: {e}")
        return []

def is_primary_account(conn, account_name):
    groups = get_failover_groups(conn)
    for group in groups:
        if group["primary"].lower() == account_name.lower():
            return True
    return False

def monitor_failover_groups(account, user, password, to_email):
    conn = connect_snowflake(account, user, password)
    groups = get_failover_groups(conn)

    # If current account is primary, connect to secondary for each group
    for group in groups:
        primary = group["primary"]
        secondary = group["secondary"]
        schedule = group["schedule"]
        last_refresh = group["last_refresh"]
        last_status = group["last_refresh_status"]
        last_duration = group["last_refresh_duration"]

        # Check for failure
        if last_status.lower() != "success":
            subject = f"Snowflake Replication Failure: {group['name']}"
            body = f"Failover group {group['name']} last refresh failed at {last_refresh}."
            send_email(subject, body, to_email)
            logging.info(f"Replication failure detected for {group['name']}")

        # Check for latency
        try:
            now = datetime.now(timezone.utc)
            last_refresh_time = datetime.strptime(last_refresh, "%Y-%m-%d %H:%M:%S.%f %Z")
            cron = croniter(schedule, last_refresh_time)
            next_expected = cron.get_next(datetime)
            interval = (next_expected - last_refresh_time).total_seconds()
            duration = float(last_duration)
            allowed_latency = interval + duration + 0.1 * duration
            actual_latency = (now - last_refresh_time).total_seconds()
            if actual_latency > allowed_latency:
                subject = f"Snowflake Replication Latency: {group['name']}"
                body = (f"Failover group {group['name']} has replication latency.\n"
                        f"Last refresh: {last_refresh}\n"
                        f"Allowed latency: {allowed_latency:.2f}s, Actual latency: {actual_latency:.2f}s")
                send_email(subject, body, to_email)
                logging.info(f"Replication latency detected for {group['name']}")
        except Exception as e:
            log_error(f"Error checking latency for {group['name']}: {e}")

    conn.close()

if __name__ == "__main__":
    if len(sys.argv) < 5:
        print("Usage: python monitor_snowflake.py <account> <user> <password> <alert_email>")
        sys.exit(1)
    account, user, password, to_email = sys.argv[1:5]
    monitor_failover_groups(account, user, password, to_email)
