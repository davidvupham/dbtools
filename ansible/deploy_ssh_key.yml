---
# Deploy SSH Public Key to Linux Hosts
#
# This playbook deploys an SSH public key to target Linux hosts.
# Useful for deploying a Windows SSH key to WSL or RHEL servers.
#
# Usage:
#
#   # Deploy to localhost (WSL)
#   ansible-playbook deploy_ssh_key.yml -i inventory/localhost.yml \
#     -e "ssh_public_key_file=/mnt/c/Users/YOUR_USERNAME/.ssh/id_ed25519.pub"
#
#   # Deploy to a remote RHEL server
#   ansible-playbook deploy_ssh_key.yml -i inventory/rhel_hosts.yml \
#     -e "ssh_public_key_file=/mnt/c/Users/YOUR_USERNAME/.ssh/id_ed25519.pub" \
#     --ask-pass
#
#   # Deploy using key content directly
#   ansible-playbook deploy_ssh_key.yml -i inventory/localhost.yml \
#     -e "ssh_public_key='ssh-ed25519 AAAA... you@example.com'"

- name: Deploy SSH Public Key
  hosts: all
  become: false

  vars:
    # Target user to add the key to (defaults to ansible_user or current user)
    target_user: "{{ ansible_user_id }}"
    target_user_home: "{{ ansible_env.HOME }}"

  pre_tasks:
    - name: Validate that either ssh_public_key or ssh_public_key_file is provided
      ansible.builtin.assert:
        that:
          - ssh_public_key is defined or ssh_public_key_file is defined
        fail_msg: |
          You must provide either:
            -e "ssh_public_key='ssh-ed25519 AAAA... comment'"
          or:
            -e "ssh_public_key_file=/path/to/id_ed25519.pub"

    - name: Read public key from file if provided
      ansible.builtin.set_fact:
        ssh_public_key: "{{ lookup('file', ssh_public_key_file) }}"
      when: ssh_public_key_file is defined and ssh_public_key is not defined

    - name: Display key info
      ansible.builtin.debug:
        msg: |
          Deploying SSH key to: {{ target_user }}@{{ inventory_hostname }}
          Key: {{ ssh_public_key | truncate(60, True, '...') }}

  tasks:
    - name: Ensure .ssh directory exists
      ansible.builtin.file:
        path: "{{ target_user_home }}/.ssh"
        state: directory
        owner: "{{ target_user }}"
        mode: "0700"

    - name: Add SSH public key to authorized_keys
      ansible.posix.authorized_key:
        user: "{{ target_user }}"
        key: "{{ ssh_public_key }}"
        state: present
        exclusive: false
      register: key_result

    - name: Display result
      ansible.builtin.debug:
        msg: |
          {% if key_result.changed %}
          SUCCESS: SSH key added to {{ target_user_home }}/.ssh/authorized_keys
          {% else %}
          INFO: SSH key already present in authorized_keys
          {% endif %}

  post_tasks:
    - name: Display next steps
      ansible.builtin.debug:
        msg: |
          ============================================================
          SSH key deployed successfully!

          Test your connection:
            ssh {{ target_user }}@{{ ansible_host | default(inventory_hostname) }}

          If connecting from Windows PowerShell:
            ssh {{ target_user }}@{{ ansible_host | default(inventory_hostname) }}
          ============================================================
      run_once: true

