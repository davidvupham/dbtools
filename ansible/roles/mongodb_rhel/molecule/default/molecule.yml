---
# Molecule scenario: Docker with Rocky Linux 9
#
# Tests the mongodb_rhel role in a privileged container with systemd.
# Validates sysctl parameters, systemd drop-ins, and tuned profile creation.
#
# Limitations (Docker containers):
#   - SELinux is not functional — SELinux tasks are skipped
#   - THP sysfs may be read-only — THP write is skipped, file creation verified
#   - mongod is not installed — ulimit checks verify the config file, not the process
#
# Usage:
#   cd ansible/roles/mongodb_rhel
#   molecule test                # Full test sequence
#   molecule converge            # Apply the role only
#   molecule verify              # Run verification only
#   molecule test --destroy never # Keep container after test for debugging

dependency:
  name: galaxy
  options:
    requirements-file: ../requirements.yml

driver:
  name: podman

platforms:
  - name: rhel9-mongodb
    image: geerlingguy/docker-rockylinux9-ansible:latest
    command: ""
    pre_build_image: true
    privileged: true
    tmpfs:
      /run: rw
      /tmp: rw
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    groups:
      - mongodb_servers

provisioner:
  name: ansible
  env:
    ANSIBLE_ROLES_PATH: "../../.."
  config_options:
    defaults:
      callbacks_enabled: profile_tasks
      stdout_callback: default
      result_format: yaml
      timeout: 30

verifier:
  name: ansible

scenario:
  name: default
  test_sequence:
    - dependency
    - syntax
    - create
    - prepare
    - converge
    - idempotence
    - verify
    - destroy
