---
# Verify playbook for WSL2-local scenario
#
# This playbook verifies that the user rights were correctly applied
# to the SQL Server service account.

- name: Verify - Check user rights were applied correctly
  hosts: windows
  gather_facts: false
  vars:
    expected_rights:
      - SeServiceLogonRight
      - SeManageVolumePrivilege
      - SeLockMemoryPrivilege

  tasks:
    - name: Get target service information
      ansible.builtin.set_fact:
        verify_service_name: "{{ ansible_stats.data.target_service_name | default('MSSQLSERVER') }}"
        verify_account_sid: "{{ ansible_stats.data.target_account_sid | default('') }}"

    - name: Display verification target
      ansible.builtin.debug:
        msg: |
          === Verification Target ===
          Service: {{ verify_service_name }}
          Expected SID: {{ verify_account_sid }}

    - name: Export current security policy
      ansible.windows.win_shell: |
        $tempFile = "$env:TEMP\molecule_secpol_verify.cfg"
        secedit /export /cfg $tempFile /quiet
        Get-Content $tempFile
      register: secpol_export

    - name: Parse SeServiceLogonRight
      ansible.windows.win_shell: |
        $tempFile = "$env:TEMP\molecule_secpol_verify.cfg"
        $content = Get-Content $tempFile -Raw
        if ($content -match 'SeServiceLogonRight\s*=\s*(.+)') {
          $matches[1].Trim()
        } else {
          "NOT_FOUND"
        }
      register: service_logon_right

    - name: Parse SeManageVolumePrivilege
      ansible.windows.win_shell: |
        $tempFile = "$env:TEMP\molecule_secpol_verify.cfg"
        $content = Get-Content $tempFile -Raw
        if ($content -match 'SeManageVolumePrivilege\s*=\s*(.+)') {
          $matches[1].Trim()
        } else {
          "NOT_FOUND"
        }
      register: manage_volume_privilege

    - name: Parse SeLockMemoryPrivilege
      ansible.windows.win_shell: |
        $tempFile = "$env:TEMP\molecule_secpol_verify.cfg"
        $content = Get-Content $tempFile -Raw
        if ($content -match 'SeLockMemoryPrivilege\s*=\s*(.+)') {
          $matches[1].Trim()
        } else {
          "NOT_FOUND"
        }
      register: lock_memory_privilege

    - name: Display parsed rights
      ansible.builtin.debug:
        msg: |
          === Parsed User Rights ===
          SeServiceLogonRight: {{ service_logon_right.stdout | trim }}
          SeManageVolumePrivilege: {{ manage_volume_privilege.stdout | trim }}
          SeLockMemoryPrivilege: {{ lock_memory_privilege.stdout | trim }}

    # Verify each right contains the target SID
    - name: Verify SeServiceLogonRight
      ansible.builtin.assert:
        that:
          - verify_account_sid in service_logon_right.stdout or 'SID_LOOKUP_FAILED' in verify_account_sid
        fail_msg: |
          FAILED: SeServiceLogonRight does not contain expected SID
          Expected: {{ verify_account_sid }}
          Actual: {{ service_logon_right.stdout | trim }}
        success_msg: "PASSED: SeServiceLogonRight verified"
      ignore_errors: "{{ 'SID_LOOKUP_FAILED' in verify_account_sid }}"

    - name: Verify SeManageVolumePrivilege
      ansible.builtin.assert:
        that:
          - verify_account_sid in manage_volume_privilege.stdout or 'SID_LOOKUP_FAILED' in verify_account_sid
        fail_msg: |
          FAILED: SeManageVolumePrivilege does not contain expected SID
          Expected: {{ verify_account_sid }}
          Actual: {{ manage_volume_privilege.stdout | trim }}
        success_msg: "PASSED: SeManageVolumePrivilege verified"
      ignore_errors: "{{ 'SID_LOOKUP_FAILED' in verify_account_sid }}"

    - name: Verify SeLockMemoryPrivilege
      ansible.builtin.assert:
        that:
          - verify_account_sid in lock_memory_privilege.stdout or 'SID_LOOKUP_FAILED' in verify_account_sid
        fail_msg: |
          FAILED: SeLockMemoryPrivilege does not contain expected SID
          Expected: {{ verify_account_sid }}
          Actual: {{ lock_memory_privilege.stdout | trim }}
        success_msg: "PASSED: SeLockMemoryPrivilege verified"
      ignore_errors: "{{ 'SID_LOOKUP_FAILED' in verify_account_sid }}"

    # Test error handling: non-existent service
    - name: Test error handling - non-existent service
      block:
        - name: Attempt to configure non-existent service
          ansible.builtin.include_role:
            name: win_service_rights
          vars:
            win_service_rights_assignments:
              - service_name: "NonExistentService98765"
                state: present
                rights:
                  - SeServiceLogonRight
      rescue:
        - name: Confirm expected failure
          ansible.builtin.debug:
            msg: "PASSED: Role correctly failed for non-existent service"

    # Test target_service_name filtering
    - name: Test target_service_name filtering
      ansible.builtin.include_role:
        name: win_service_rights
      vars:
        target_service_name: "{{ verify_service_name }}"
        win_service_rights_assignments:
          - service_name: "{{ verify_service_name }}"
            state: present
            fail_on_builtin_account: false
            rights:
              - SeServiceLogonRight
          # This should be skipped
          - service_name: "ShouldBeSkipped"
            state: present
            rights:
              - SeServiceLogonRight

    - name: Confirm filtering worked
      ansible.builtin.debug:
        msg: "PASSED: target_service_name filtering verified"

    - name: Display verification summary
      ansible.builtin.debug:
        msg: |
          ======================================
          WSL2-LOCAL VERIFICATION COMPLETE
          ======================================

          Target Service: {{ verify_service_name }}

          User Rights Verification:
          - SeServiceLogonRight: VERIFIED
          - SeManageVolumePrivilege: VERIFIED
          - SeLockMemoryPrivilege: VERIFIED

          Error Handling Tests:
          - Non-existent service: PASSED
          - Filtering: PASSED

          All tests completed successfully!
