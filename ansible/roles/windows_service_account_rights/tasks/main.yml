---
# tasks file for windows_service_account_rights
# This role retrieves the service account for a Windows service and manages user rights

- name: Validate user_rights_action parameter
  ansible.builtin.fail:
    msg: "user_rights_action must be 'add' or 'remove', got: {{ user_rights_action }}"
  when: user_rights_action not in ['add', 'remove']

- name: Get service information
  ansible.windows.win_service_info:
    name: "{{ service_name }}"
  register: service_info

- name: Fail if service does not exist
  ansible.builtin.fail:
    msg: "Service '{{ service_name }}' not found on {{ inventory_hostname }}"
  when: service_info.services | length == 0

- name: Extract service account from service info
  ansible.builtin.set_fact:
    service_account: "{{ service_info.services[0].username }}"

- name: Display service account
  ansible.builtin.debug:
    msg: "Service '{{ service_name }}' runs as: {{ service_account }}"

- name: Fail if service runs as LocalSystem, LocalService, or NetworkService
  ansible.builtin.fail:
    msg: "Service runs as {{ service_account }}. This role is designed for domain/local user accounts, not built-in system accounts."
  when: >
    service_account in ['LocalSystem', 'NT AUTHORITY\\LocalService', 'NT AUTHORITY\\NetworkService',
                        'LocalService', 'NetworkService', '.\\LocalSystem']

- name: "{{ user_rights_action | capitalize }} 'Log on as a service' right"
  ansible.windows.win_user_right:
    name: SeServiceLogonRight
    users:
      - "{{ service_account }}"
    action: "{{ user_rights_action }}"
  when: "'SeServiceLogonRight' in user_rights_to_grant"

- name: "{{ user_rights_action | capitalize }} 'Perform volume maintenance tasks' right"
  ansible.windows.win_user_right:
    name: SeManageVolumePrivilege
    users:
      - "{{ service_account }}"
    action: "{{ user_rights_action }}"
  when: "'SeManageVolumePrivilege' in user_rights_to_grant"

- name: "{{ user_rights_action | capitalize }} 'Lock pages in memory' right"
  ansible.windows.win_user_right:
    name: SeLockMemoryPrivilege
    users:
      - "{{ service_account }}"
    action: "{{ user_rights_action }}"
  when: "'SeLockMemoryPrivilege' in user_rights_to_grant"

- name: Display action summary
  ansible.builtin.debug:
    msg: "Successfully {{ 'granted' if user_rights_action == 'add' else 'removed' }} the following rights {{ 'to' if user_rights_action == 'add' else 'from' }} {{ service_account }}: {{ user_rights_to_grant | join(', ') }}"
