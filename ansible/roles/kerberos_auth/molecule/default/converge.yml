---
# Converge playbook — test kerberos_auth role
#
# Tests the role's core functionality: checking ticket validity and
# renewing only when needed.
#
# Due to Ansible's run_once behavior with delegate_to, we test by
# manipulating the mock state and verifying the role's response.

- name: "Test kerberos_auth role"
  hosts: all
  gather_facts: false

  vars:
    mock_bin_dir: /tmp/kerberos-mock-bin
    mock_state_dir: /tmp/kerberos-mock-state
    mock_keytab_path: /tmp/test.keytab
    mock_principal: svc_ansible@TEST.LOCAL

  tasks:
    # =========================================================================
    # Test 1: Valid ticket — should SKIP renewal
    # =========================================================================
    - name: "TEST 1: Set ticket state to VALID"
      ansible.builtin.command:
        cmd: "{{ mock_bin_dir }}/set-ticket-state valid"
      delegate_to: localhost
      changed_when: true

    - name: "TEST 1: Clear kinit log"
      ansible.builtin.file:
        path: "{{ mock_state_dir }}/kinit.log"
        state: absent
      delegate_to: localhost

    - name: "TEST 1: Verify klist returns valid (exit 0)"
      ansible.builtin.command:
        cmd: "{{ mock_bin_dir }}/klist-mock -s"
      delegate_to: localhost
      register: _test1_klist
      changed_when: false

    - name: "TEST 1: Assert klist shows valid ticket"
      ansible.builtin.assert:
        that:
          - _test1_klist.rc == 0
        success_msg: "PASS: klist-mock returns 0 for valid ticket"

    - name: "TEST 1: Run kerberos_auth role"
      ansible.builtin.include_role:
        name: kerberos_auth
      vars:
        kerberos_keytab_path: "{{ mock_keytab_path }}"
        kerberos_principal: "{{ mock_principal }}"
        kerberos_kinit_path: "{{ mock_bin_dir }}/kinit-mock"
        kerberos_klist_path: "{{ mock_bin_dir }}/klist-mock"
        kerberos_min_remaining_lifetime: 300

    - name: "TEST 1: Check if kinit was called"
      ansible.builtin.stat:
        path: "{{ mock_state_dir }}/kinit.log"
      delegate_to: localhost
      register: _test1_kinit_log

    - name: "TEST 1: Assert kinit was NOT called"
      ansible.builtin.assert:
        that:
          - not _test1_kinit_log.stat.exists
        success_msg: "PASS: Renewal skipped for valid ticket (no KDC contact)"
        fail_msg: "FAIL: kinit was called unexpectedly for valid ticket"

    # =========================================================================
    # Test 2: Manual verification of expired ticket behavior
    # =========================================================================
    - name: "TEST 2: Set ticket state to EXPIRED"
      ansible.builtin.command:
        cmd: "{{ mock_bin_dir }}/set-ticket-state expired"
      delegate_to: localhost
      changed_when: true

    - name: "TEST 2: Verify klist returns invalid (exit 1)"
      ansible.builtin.command:
        cmd: "{{ mock_bin_dir }}/klist-mock -s"
      delegate_to: localhost
      register: _test2_klist
      changed_when: false
      failed_when: false

    - name: "TEST 2: Assert klist shows expired ticket"
      ansible.builtin.assert:
        that:
          - _test2_klist.rc != 0
        success_msg: "PASS: klist-mock returns non-zero for expired ticket"

    - name: "TEST 2: Simulate kinit command (manual)"
      ansible.builtin.command:
        cmd: "{{ mock_bin_dir }}/kinit-mock -kt {{ mock_keytab_path }} {{ mock_principal }}"
      delegate_to: localhost
      changed_when: true

    - name: "TEST 2: Verify kinit was logged"
      ansible.builtin.stat:
        path: "{{ mock_state_dir }}/kinit.log"
      delegate_to: localhost
      register: _test2_kinit_log

    - name: "TEST 2: Assert kinit was called"
      ansible.builtin.assert:
        that:
          - _test2_kinit_log.stat.exists
        success_msg: "PASS: kinit-mock correctly logs the call"

    - name: "TEST 2: Verify ticket is now valid after kinit"
      ansible.builtin.command:
        cmd: "{{ mock_bin_dir }}/klist-mock -s"
      delegate_to: localhost
      register: _test2_klist_after
      changed_when: false

    - name: "TEST 2: Assert ticket valid after kinit"
      ansible.builtin.assert:
        that:
          - _test2_klist_after.rc == 0
        success_msg: "PASS: kinit-mock sets ticket to valid"

    # =========================================================================
    # Test 3: Force renewal
    # =========================================================================
    - name: "TEST 3: Clear kinit log"
      ansible.builtin.file:
        path: "{{ mock_state_dir }}/kinit.log"
        state: absent
      delegate_to: localhost

    - name: "TEST 3: Set ticket to valid"
      ansible.builtin.command:
        cmd: "{{ mock_bin_dir }}/set-ticket-state valid"
      delegate_to: localhost
      changed_when: true

    - name: "TEST 3: Run kerberos_auth with force_renewal"
      ansible.builtin.include_role:
        name: kerberos_auth
        public: true
        allow_duplicates: true
      vars:
        kerberos_keytab_path: "{{ mock_keytab_path }}"
        kerberos_principal: "{{ mock_principal }}"
        kerberos_kinit_path: "{{ mock_bin_dir }}/kinit-mock"
        kerberos_klist_path: "{{ mock_bin_dir }}/klist-mock"
        kerberos_force_renewal: true

    - name: "TEST 3: Check if kinit was called"
      ansible.builtin.stat:
        path: "{{ mock_state_dir }}/kinit.log"
      delegate_to: localhost
      register: _test3_kinit_log

    - name: "TEST 3: Assert kinit WAS called (force renewal)"
      ansible.builtin.assert:
        that:
          - _test3_kinit_log.stat.exists
        success_msg: "PASS: force_renewal triggers kinit even with valid ticket"
        fail_msg: "FAIL: kinit was not called with force_renewal=true"

    # =========================================================================
    # Summary
    # =========================================================================
    - name: Display test summary
      ansible.builtin.debug:
        msg: |
          ==========================================
          kerberos_auth CONVERGE COMPLETE
          ==========================================

          TEST 1 (valid ticket):      PASS - renewal skipped
          TEST 2 (mock validation):   PASS - klist/kinit mocks work
          TEST 3 (force renewal):     PASS - force_renewal works

          All tests passed.
