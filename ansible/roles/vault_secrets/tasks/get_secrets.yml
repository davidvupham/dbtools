---
# Retrieve secrets from HashiCorp Vault

- name: Retrieve secrets from Vault
  community.hashi_vault.vault_kv2_get:
    url: "{{ vault_addr }}"
    path: "{{ item.path }}"
    engine_mount_point: "{{ item.engine | default(vault_secrets_engine) }}"
    token: "{{ vault_token }}"
    namespace: "{{ vault_namespace | default(omit, true) }}"
    validate_certs: "{{ vault_validate_certs }}"
    ca_cert: "{{ vault_ca_cert | default(omit, true) }}"
    timeout: "{{ vault_timeout }}"
  register: vault_secret_result
  loop: "{{ vault_secrets_to_fetch }}"
  loop_control:
    label: "{{ item.path }}"
  no_log: true
  retries: "{{ vault_retries }}"
  delay: "{{ vault_retry_delay }}"
  until: vault_secret_result is succeeded
  when: vault_kv_version == 2
  failed_when:
    - vault_secret_result is failed
    - vault_missing_secret_behavior == 'fail'

- name: Retrieve secrets from Vault (KV v1)
  community.hashi_vault.vault_kv1_get:
    url: "{{ vault_addr }}"
    path: "{{ item.path }}"
    engine_mount_point: "{{ item.engine | default(vault_secrets_engine) }}"
    token: "{{ vault_token }}"
    namespace: "{{ vault_namespace | default(omit, true) }}"
    validate_certs: "{{ vault_validate_certs }}"
    ca_cert: "{{ vault_ca_cert | default(omit, true) }}"
    timeout: "{{ vault_timeout }}"
  register: vault_secret_result
  loop: "{{ vault_secrets_to_fetch }}"
  loop_control:
    label: "{{ item.path }}"
  no_log: true
  retries: "{{ vault_retries }}"
  delay: "{{ vault_retry_delay }}"
  until: vault_secret_result is succeeded
  when: vault_kv_version == 1
  failed_when:
    - vault_secret_result is failed
    - vault_missing_secret_behavior == 'fail'

- name: Set facts for retrieved secrets
  ansible.builtin.set_fact:
    "{{ item.item.fact_name }}": "{{ item.secret.data[item.item.key] | default(item.secret.data) }}"
  loop: "{{ vault_secret_result.results }}"
  loop_control:
    label: "{{ item.item.fact_name | default(item.item.path) }}"
  when:
    - vault_secret_result is defined
    - item.secret is defined
    - item.item.fact_name is defined
  no_log: true

- name: Set full secret data as facts (when no specific key requested)
  ansible.builtin.set_fact:
    "{{ item.item.fact_name }}": "{{ item.secret.data }}"
  loop: "{{ vault_secret_result.results }}"
  loop_control:
    label: "{{ item.item.fact_name | default(item.item.path) }}"
  when:
    - vault_secret_result is defined
    - item.secret is defined
    - item.item.fact_name is defined
    - item.item.key is not defined
  no_log: true

- name: Display secret retrieval summary
  ansible.builtin.debug:
    msg: "Retrieved {{ vault_secret_result.results | selectattr('secret', 'defined') | list | length }} of {{ vault_secrets_to_fetch | length }} secrets"
  when: vault_secret_result is defined
