---
# Standalone task file for retrieving a single secret using lookup
# Include this in playbooks for one-off secret retrieval
#
# Required variables:
#   - vault_secret_path: Path to the secret (e.g., "myapp/config")
#   - vault_secret_fact_name: Name of the fact to store the secret
#
# Optional variables:
#   - vault_secret_key: Specific key within the secret data
#   - vault_secret_engine: Secrets engine mount point (default: kv-v2)

- name: Validate lookup parameters
  ansible.builtin.assert:
    that:
      - vault_secret_path is defined and vault_secret_path | length > 0
      - vault_secret_fact_name is defined and vault_secret_fact_name | length > 0
    fail_msg: "vault_secret_path and vault_secret_fact_name are required"
    quiet: true

- name: Retrieve secret using lookup
  ansible.builtin.set_fact:
    "{{ vault_secret_fact_name }}": >-
      {{
        lookup('community.hashi_vault.vault_kv2_get',
          vault_secret_path,
          url=vault_addr,
          token=vault_token,
          engine_mount_point=vault_secret_engine | default(vault_secrets_engine),
          namespace=vault_namespace | default(omit),
          validate_certs=vault_validate_certs
        ).secret.data[vault_secret_key]
        if vault_secret_key is defined
        else
        lookup('community.hashi_vault.vault_kv2_get',
          vault_secret_path,
          url=vault_addr,
          token=vault_token,
          engine_mount_point=vault_secret_engine | default(vault_secrets_engine),
          namespace=vault_namespace | default(omit),
          validate_certs=vault_validate_certs
        ).secret.data
      }}
  no_log: true
