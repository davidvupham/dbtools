# ==============================================================================
# Liquibase Docker Compose Configuration
# ==============================================================================
#
# PURPOSE:
# This docker-compose file provides a convenient way to run Liquibase
# database migrations with proper volume mounts and network configuration.
#
# USAGE:
# This is a "run-once" service pattern - Liquibase runs a migration and exits
# It's not a long-running service like a database or web server
#
# ==============================================================================

version: "3.8"

services:
  # ----------------------------------------------------------------------------
  # Liquibase Service
  # ----------------------------------------------------------------------------
  # This service runs Liquibase commands against your databases
  # By default, it shows help and exits - override with specific commands
  liquibase:
    # Build configuration - uses local Dockerfile
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # You can override these versions at build time
        LIQUIBASE_VERSION: 5.0.1
        MSSQL_DRIVER_VERSION: 13.2.1
        POSTGRES_DRIVER_VERSION: 42.7.8
        SNOWFLAKE_DRIVER_VERSION: 3.27.1
        MONGODB_DRIVER_VERSION: 3.12.14
        LIQUIBASE_MONGODB_VERSION: 5.0.1

    # Image name after build
    image: liquibase:5.0.1

    # Container name (easier to reference than auto-generated name)
    container_name: liquibase

    # Working directory inside container
    working_dir: /liquibase

    # Volume Mounts - CRITICAL FOR OPERATIONS
    # Maps your local changelog files into the container
    volumes:
      # Changelogs directory - where your migration scripts live
      # Adjust the local path to match your project structure
      - ./changelogs:/liquibase/changelogs:ro
      # Note: :ro = read-only mount (container can't modify your files)

      # Optional: Properties file for connection details
      # Uncomment and create liquibase.properties file if needed
      # - ./liquibase.properties:/liquibase/liquibase.properties:ro

      # Optional: Output directory for generated SQL, reports, etc.
      # - ./output:/liquibase/output

    # Network Configuration
    # Allows Liquibase to connect to database containers
    networks:
      - tool-library-network

    # Environment Variables
    # These can be referenced in your liquibase.properties or changelogs
    environment:
      # Optional: Set default log level
      - LIQUIBASE_LOG_LEVEL=INFO

      # Optional: License key for Liquibase Pro features
      # - LIQUIBASE_LICENSE_KEY=${LIQUIBASE_LICENSE_KEY}

    # Command override example
    # By default, runs 'liquibase --help' (from Dockerfile CMD)
    # Override with specific commands when running
    # command: --help

    # Restart policy - "no" is appropriate for run-once tools
    # Liquibase runs a migration and exits, shouldn't restart automatically
    restart: "no"

    # Resource limits (optional but recommended)
    # Prevents Liquibase from consuming too much memory/CPU
    deploy:
      resources:
        limits:
          cpus: "1.0" # Max 1 CPU core
          memory: 1G # Max 1GB RAM
        reservations:
          cpus: "0.25" # Reserve at least 0.25 CPU
          memory: 256M # Reserve at least 256MB RAM

# ------------------------------------------------------------------------------
# Networks
# ------------------------------------------------------------------------------
# Connect to existing database network or create a new one
networks:
  tool-library-network:
    # Use external network if databases are in a separate docker-compose
    # Uncomment if your databases are in another compose file
    # external: true

    # Or let this compose create the network
    driver: bridge
    name: dbtools-network
# ==============================================================================
# USAGE EXAMPLES:
# ==============================================================================
#
# Show help:
#   docker-compose run --rm liquibase --help
#
# Run update (apply all pending changes):
#   docker-compose run --rm liquibase \
#     --url=jdbc:postgresql://postgres:5432/mydb \
#     --username=dbuser \
#     --password=dbpass \
#     --changelog-file=changelogs/master.xml \
#     update
#
# Check status (what changes are pending):
#   docker-compose run --rm liquibase \
#     --url=jdbc:sqlserver://mssql1:1433;databaseName=mydb \
#     --username=SA \
#     --password=YourStrong!Passw0rd \
#     --changelog-file=changelogs/master.xml \
#     status --verbose
#
# Rollback last change:
#   docker-compose run --rm liquibase \
#     --url=jdbc:postgresql://postgres:5432/mydb \
#     --username=dbuser \
#     --password=dbpass \
#     --changelog-file=changelogs/master.xml \
#     rollback-count 1
#
# Generate SQL without applying (dry run):
#   docker-compose run --rm liquibase \
#     --url=jdbc:postgresql://postgres:5432/mydb \
#     --username=dbuser \
#     --password=dbpass \
#     --changelog-file=changelogs/master.xml \
#     update-sql
#
# Using properties file:
#   docker-compose run --rm liquibase \
#     --defaults-file=/liquibase/liquibase.properties \
#     update
#
# ==============================================================================
# DATABASE CONNECTION STRINGS:
# ==============================================================================
#
# PostgreSQL:
#   --url=jdbc:postgresql://postgres:5432/dbname
#   or from host: jdbc:postgresql://localhost:5432/dbname
#
# SQL Server:
#   --url=jdbc:sqlserver://mssql1:1433;databaseName=dbname
#   or from host: jdbc:sqlserver://localhost:1433;databaseName=dbname
#
# Snowflake:
#   --url=jdbc:snowflake://account.snowflakecomputing.com/?db=dbname&warehouse=wh
#
# MongoDB:
#   --url=jdbc:mongodb://mongodb1:27017/dbname
#
# ==============================================================================
