{
  // ===========================================================================
  // VS Code Dev Container Configuration
  // ===========================================================================
  //
  // PURPOSE:
  // This file configures a development container (dev container) for VS Code.
  // A dev container is a Docker container that serves as a fully-featured
  // development environment with all tools, dependencies, and extensions
  // pre-installed and configured.
  //
  // BENEFITS:
  // 1. Consistent development environment across all developers
  // 2. No need to install Python, databases, or tools on your local machine
  // 3. Isolated from your host system (won't affect other projects)
  // 4. Can run Docker containers inside this dev container (Docker-in-Docker)
  // 5. Automatic VS Code extension installation
  //
  // HOW IT WORKS:
  // When you open this project in VS Code and have the "Dev Containers"
  // extension installed, VS Code will:
  // 1. Build a Docker image from .devcontainer/Dockerfile
  // 2. Start a container from that image
  // 3. Install VS Code extensions inside the container
  // 4. Connect your VS Code window to the running container
  // 5. All terminal commands, file edits, and debugging happen inside container
  //
  // ===========================================================================
  // ---------------------------------------------------------------------------
  // Container Identity
  // ---------------------------------------------------------------------------
  // "name": Display name shown in VS Code UI
  // This helps identify which dev container you're working in
  "name": "dbtools (venv)",
  // ---------------------------------------------------------------------------
  // Build Configuration
  // ---------------------------------------------------------------------------
  // Tells VS Code how to build the Docker image for this dev container
  //
  // "dockerfile": Path to Dockerfile (relative to this .devcontainer directory)
  // "context": Build context directory (parent of .devcontainer)
  //   - This allows Dockerfile to access files in the project root
  // "args": Build-time variables passed to the Dockerfile
  //   - PYTHON_VERSION: Python version to install (3.14)
  //   - CONDA_ENV_NAME: Name of the conda environment (gds)
  //   - DEVCONTAINER_USER: Username to create in container (defaults to host user)
  //   - DEVCONTAINER_UID: User ID (defaults to host user ID)
  //   - DEVCONTAINER_GID: Group ID (defaults to host group ID)
  "build": {
    "dockerfile": "Dockerfile",
    "context": "..",
    "args": {
      "DEVCONTAINER_USER": "${localEnv:USER}",
      "USE_PYENV": "0",
      "PYENV_PYTHON_VERSION": "3.14.0"
    }
  },
  // ---------------------------------------------------------------------------
  // User Configuration
  // ---------------------------------------------------------------------------
  // "remoteUser": User account to use inside the container
  // - All VS Code operations run as this user
  // - Matches the user created in Dockerfile (uses host user)
  // - Files created will be owned by this user
  "remoteUser": "${localEnv:USER}",
  // ---------------------------------------------------------------------------
  // Features (Pre-built Capabilities)
  // ---------------------------------------------------------------------------
  // Features are reusable components that add functionality to dev containers
  // They're maintained by Microsoft and the community
  //
  // Available features: https://containers.dev/features
  "features": {
    "ghcr.io/devcontainers/features/common-utils:2": {
      "installZsh": false
    },
    "ghcr.io/devcontainers/features/git:1": {}
  },
  // ---------------------------------------------------------------------------
  // VS Code Customizations
  // ---------------------------------------------------------------------------
  // Configure VS Code extensions and settings for this dev container
  "customizations": {
    "vscode": {
      // Extensions to install automatically when dev container starts
      // Users don't need to manually install these - they're pre-configured
      "extensions": [
        // Python Development
        "ms-python.python", // Python language support
        "ms-python.vscode-pylance", // Fast Python language server
        "ms-python.debugpy", // Python debugger
        "charliermarsh.ruff", // Fast Python linter/formatter
        // GitHub Copilot
        "GitHub.copilot", // Copilot core extension (remote)
        "GitHub.copilot-chat", // Copilot Chat UI (remote)
        // PowerShell
        "ms-vscode.powershell", // PowerShell language support
        // Testing
        "littlefoxteam.vscode-python-test-adapter", // Test explorer
        "ryanluker.vscode-coverage-gutters", // Show code coverage
        // Database Tools
        "mtxr.sqltools", // Universal database client
        "mtxr.sqltools-driver-pg", // PostgreSQL driver for SQLTools
        "mtxr.sqltools-driver-mssql", // SQL Server driver for SQLTools
        // Jupyter
        "ms-toolsai.jupyter", // Jupyter notebook support
        "ms-toolsai.jupyter-keymap", // Jupyter keyboard shortcuts
        // Docker
        "ms-azuretools.vscode-docker", // Docker management in VS Code
        // Git
        "eamodio.gitlens", // Enhanced Git capabilities
        // Code Quality
        "editorconfig.editorconfig", // EditorConfig support
        "davidanson.vscode-markdownlint", // Markdown linting
        // Utilities
        "streetsidesoftware.code-spell-checker", // Spell checker
        "redhat.vscode-yaml", // YAML language support
        "tamasfe.even-better-toml" // TOML language support
      ],
      // Settings applied to VS Code when running in this dev container
      // These override user settings and ensure consistency
      "settings": {
        // Python Configuration (venv)
        "python.defaultInterpreterPath": "/workspaces/dbtools/.venv/bin/python",
        "python.terminal.activateEnvironment": true,
        "python.analysis.autoImportCompletions": true,
        "python.analysis.typeCheckingMode": "basic",
        // Testing Configuration
        "python.testing.pytestEnabled": true,
        "python.testing.unittestEnabled": false,
        "python.testing.pytestArgs": [
          ".",
          "-v",
          "--tb=short"
        ],
        "python.testing.autoTestDiscoverOnSaveEnabled": true,
        // Formatting and Linting
        "editor.formatOnSave": true,
        "editor.codeActionsOnSave": {
          "source.organizeImports": "explicit"
        },
        "ruff.enable": true,
        "ruff.organizeImports": true,
        "ruff.fixAll": true,
        // PowerShell
        "powershell.integratedConsole.showOnStartup": false,
        // Editor Settings
        "editor.rulers": [
          88,
          120
        ],
        "editor.tabSize": 4,
        "editor.insertSpaces": true,
        "files.trimTrailingWhitespace": true,
        "files.insertFinalNewline": true,
        // File Associations
        "files.associations": {
          "*.sql": "sql",
          "*.psql": "sql",
          "Dockerfile*": "dockerfile"
        },
        // Search Exclusions
        "search.exclude": {
          "**/__pycache__": true,
          "**/.pytest_cache": true,
          "**/*.pyc": true,
          "**/htmlcov": true,
          "**/.coverage": true,
          "**/dist": true,
          "**/*.egg-info": true
        },
        // File Watcher Exclusions
        "files.watcherExclude": {
          "**/__pycache__/**": true,
          "**/.pytest_cache/**": true,
          "**/htmlcov/**": true,
          "**/.git/objects/**": true,
          "**/.git/subtree-cache/**": true,
          "**/dist/**": true,
          "**/*.egg-info/**": true
        },
        // Git
        "git.autofetch": true,
        "git.confirmSync": false,
        // Terminal
        "terminal.integrated.defaultProfile.linux": "bash",
        "terminal.integrated.profiles.linux": {
          "bash": {
            "path": "/bin/bash",
            "args": [
              "-l"
            ]
          },
          "pwsh": {
            "path": "/usr/bin/pwsh",
            "args": [
              "-NoLogo"
            ]
          }
        }
      }
    }
  },
  // ---------------------------------------------------------------------------
  // Workspace Configuration
  // ---------------------------------------------------------------------------
  // "workspaceMount": Override the default mount so that we mount the *parent*
  // directory of the dbtools repo as /workspaces. This allows additional
  // repositories to be cloned as siblings of dbtools (e.g. /workspaces/other-repo)
  // instead of nested inside the dbtools repo.
  //
  // Example host layout:
  //   /home/user/src/
  //     dbtools/            (this repo)
  //     other-repo-1/
  //     other-repo-2/
  //
  // Inside the container:
  //   /workspaces/
  //     dbtools/
  //     other-repo-1/
  //     other-repo-2/
  //
  // NOTE: VS Code still opens /workspaces/dbtools as the workspaceFolder.
  "workspaceMount": "source=${localWorkspaceFolder}/..,target=/workspaces,type=bind",
  // "workspaceFolder": Where the project is opened inside the container
  "workspaceFolder": "/workspaces/dbtools",
  // ---------------------------------------------------------------------------
  // Initialize Command (Runs on HOST before container starts)
  // ---------------------------------------------------------------------------
  // Creates the devcontainer-network if it doesn't exist
  // This network is shared by all database containers and the dev container
  "initializeCommand": "docker network inspect devcontainer-network >/dev/null 2>&1 || docker network create --driver bridge devcontainer-network",
  // ---------------------------------------------------------------------------
  // Port Forwarding (VS Code Feature)
  // ---------------------------------------------------------------------------
  // "forwardPorts": Ports that VS Code should automatically forward
  //
  // IMPORTANT: This is for VS Code's port forwarding feature (for web apps)
  // NOT the same as publishing Docker ports to WSL host
  // See "runArgs" below for actual Docker port publishing
  //
  // When a service listens on these ports inside the dev container,
  // VS Code will:
  // 1. Detect it
  // 2. Show a notification
  // 3. Make the port accessible from your browser
  "forwardPorts": [
    5432, // PostgreSQL (if running)
    1433, // SQL Server (if running)
    27017, // MongoDB (if running)
    3000, // Common web dev port
    5000, // Common API port
    8000, // Common dev server port
    8888 // Jupyter (if running jupyter lab)
  ],
  // "portsAttributes": Configure how forwarded ports behave
  "portsAttributes": {
    "5432": {
      "label": "PostgreSQL",
      "onAutoForward": "notify" // Show notification when port is forwarded
    },
    "1433": {
      "label": "SQL Server",
      "onAutoForward": "notify"
    },
    "27017": {
      "label": "MongoDB",
      "onAutoForward": "notify"
    },
    "8000": {
      "label": "Dev Server",
      "onAutoForward": "notify"
    },
    "8888": {
      "label": "Jupyter",
      "onAutoForward": "notify"
    }
  },
  // ---------------------------------------------------------------------------
  // Container Runtime Arguments
  // ---------------------------------------------------------------------------
  // "runArgs": Arguments passed to 'docker run' when starting the container
  // These are Docker-level configurations that affect the container itself
  //
  // CRITICAL FOR DATABASE CONNECTIVITY:
  // The -p flags here publish ports from the dev container to the WSL host
  // This enables connecting to databases from outside VS Code
  "runArgs": [
    "--env",
    "PYTHONUNBUFFERED=1",
    "--network",
    "devcontainer-network"
  ],
  // ---------------------------------------------------------------------------
  // Lifecycle Commands
  // ---------------------------------------------------------------------------
  // These commands run at different stages of the dev container lifecycle
  // "postCreateCommand": Runs ONCE after the container is first created
  // Used for one-time setup: install dependencies, configure environment
  "postCreateCommand": "bash -lc 'python3 -m venv .venv && ln -sf /workspaces/dbtools/.venv/bin/python /workspaces/dbtools/.venv/bin/python3 && . .venv/bin/activate && pip install --upgrade pip && pip install ruff pytest pytest-cov pyright pyodbc ipykernel && python -m ipykernel install --user --name gds --display-name \"Python (gds)\" && if [ \"${ENABLE_JUPYTERLAB:-0}\" = \"1\" ]; then pip install --upgrade jupyterlab && python -c \"import jupyterlab; print('jupyterlab:', jupyterlab.__version__)\"; fi'",
  // "postStartCommand": Runs EVERY TIME the container starts
  // Used for recurring setup: ensure directories exist, fix permissions, install local packages
  "postStartCommand": "bash -lc 'mkdir -p ~/.vscode-server/extensions ~/.vscode-server/extensionsCache && chmod -R 775 ~/.vscode-server && chown -R ${USER}:${USER} ~/.vscode-server || true; for f in ~/.bashrc ~/.profile ~/.zshrc; do [ -f \"$f\" ] && sed -i \"/conda activate/d;/miniconda3/d\" \"$f\" || true; done; if [ -L .venv/bin/python3 ]; then T=$(readlink .venv/bin/python3 || true); if echo \"$T\" | grep -q miniconda3 || [ -n \"$T\" -a ! -e \"$T\" ]; then echo \"[postStart] Detected bad python3 symlink ($T); rebuilding venv...\"; rm -rf .venv; fi; fi; if [ ! -d .venv ]; then echo \"[postStart] Creating Python venv...\"; python3 -m venv .venv; fi; ln -sf /workspaces/dbtools/.venv/bin/python /workspaces/dbtools/.venv/bin/python3 || true; echo \"[postStart] Ensuring venv auto-activation for interactive shells...\"; grep -q \"/workspaces/dbtools/.venv/bin/activate\" ~/.bashrc || echo \"source /workspaces/dbtools/.venv/bin/activate\" >> ~/.bashrc; echo \"[postStart] Sourcing ~/.set_prompt if present...\"; grep -q \"source ~/.set_prompt\|\\. ~/.set_prompt\" ~/.bashrc || echo \"[[ -f ~/.set_prompt ]] && . ~/.set_prompt\" >> ~/.bashrc; echo \"[postStart] Purging stale caches referencing miniconda...\"; find . -type d \( -name .mypy_cache -o -name __pycache__ -o -name .pytest_cache \) -prune -exec rm -rf {} + || true; echo \"[postStart] Installing local packages in editable mode...\"; . .venv/bin/activate && pip install -q -e ./gds_database -e ./gds_postgres -e ./gds_mssql -e ./gds_mongodb -e ./gds_liquibase -e ./gds_vault -e ./gds_snowflake -e ./gds_snmp_receiver 2>/dev/null || echo \"[postStart] Some packages failed to install (dependencies may be missing)\"'",
  // ---------------------------------------------------------------------------
  // Container Environment Variables
  // ---------------------------------------------------------------------------
  // "containerEnv": Environment variables set in the container
  // Available to all processes running inside the dev container
  "containerEnv": {
    // Prevents pip from checking for newer versions on every command
    // Speeds up pip operations slightly
    "PIP_DISABLE_PIP_VERSION_CHECK": "1",
    // Optional: set to "1" to install JupyterLab during postCreate
    "ENABLE_JUPYTERLAB": "0"
  },
  // ---------------------------------------------------------------------------
  // Volume Mounts
  // ---------------------------------------------------------------------------
  // "mounts": Bind mount directories from host to container
  // Format: "source=<host-path>,target=<container-path>,type=bind,..."
  //
  // THESE ARE CRITICAL FOR PERSISTENCE AND FUNCTIONALITY
  "mounts": [
    "source=${localEnv:HOME}/.ssh,target=/home/${localEnv:USER}/.ssh,type=bind,consistency=cached,readonly",
    "source=${localEnv:HOME}/.ssh,target=/home/vscode/.ssh,type=bind,consistency=cached,readonly",
    "source=/var/run/docker.sock,target=/var/run/docker.sock,type=bind"
  ]
  // ===========================================================================
  // REBUILD INSTRUCTIONS:
  // ===========================================================================
  // After modifying this file, rebuild the dev container:
  // 1. Press F1 or Ctrl+Shift+P
  // 2. Type "Dev Containers: Rebuild Container"
  // 3. Select it and wait for rebuild
  //
  // Changes requiring rebuild:
  // - build.args modifications
  // - features additions/changes
  // - runArgs changes (like port publishing)
  // - mounts changes
  //
  // Changes NOT requiring rebuild (just reload window):
  // - customizations.vscode.settings changes
  // - forwardPorts changes
  // ===========================================================================
}
