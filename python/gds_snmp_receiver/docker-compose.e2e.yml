version: '3.8'

services:
  rabbitmq:
    image: rabbitmq:3-management
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "15672:15672" # management UI
      - "5672:5672"

  gds-snmp-receiver:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - rabbitmq
    environment:
      RABBIT_URL: "amqp://guest:guest@rabbitmq:5672/"
      SNMP_QUEUE: "alerts"
      GDS_SNMP_LOG_LEVEL: "DEBUG"
      # Use an unprivileged port for E2E tests so the container can run
      # as a non-root user without extra capabilities.
      SNMP_LISTEN_PORT: "9162"

  snmp-sender:
    image: python:3.11-slim
    command: ["sleep", "infinity"]
    volumes:
      - .:/workdir
    working_dir: /workdir
    environment:
      RECEIVER_HOST: "gds-snmp-receiver"
      RECEIVER_PORT: "9162"
      RABBIT_URL: "amqp://guest:guest@rabbitmq:5672/"
      SNMP_QUEUE: "alerts"
