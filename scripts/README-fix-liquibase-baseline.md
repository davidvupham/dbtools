# Liquibase Baseline Fixer for SQL Server

This script automatically fixes common issues with Liquibase-generated baseline XML files for SQL Server databases.

## What It Fixes

### Automatically Fixed Issues

1. **Missing `schemaName` attributes** - Adds `schemaName="app"` (or your specified schema) to all `<createTable>` and `<createView>` elements
2. **Missing schema creation** - Adds a changeset to create the schema if it doesn't exist
3. **Missing stored procedures** - Extracts and adds stored procedures from the database (with `--add-db-objects`)
4. **Missing functions** - Extracts and adds functions from the database (with `--add-db-objects`)

### Example Transformation

**Before (Generated by Liquibase):**

```xml
<databaseChangeLog ...>
    <changeSet author="root (generated)" id="1762927023071-1">
        <createTable tableName="customer">  <!-- Missing schemaName -->
            ...
        </createTable>
    </changeSet>
</databaseChangeLog>
```

**After (Fixed by Script):**

```xml
<databaseChangeLog ...>
    <changeSet id="baseline-schema-app" author="system">
        <sql>
            IF NOT EXISTS (SELECT 1 FROM sys.schemas WHERE name = 'app')
            BEGIN
                EXEC('CREATE SCHEMA app')
            END
        </sql>
    </changeSet>

    <changeSet author="root (generated)" id="1762927023071-1">
        <createTable schemaName="app" tableName="customer">  <!-- Fixed -->
            ...
        </createTable>
    </changeSet>

    <!-- Stored Procedures -->
    <changeSet id="baseline-proc-usp_add_customer" author="system" runOnChange="true">
        <sql splitStatements="false">
            CREATE OR ALTER PROCEDURE app.usp_add_customer ...
        </sql>
    </changeSet>
</databaseChangeLog>
```

## Installation

### Prerequisites

```bash
# Python 3.7 or higher
python3 --version

# Install pyodbc (only needed for --add-db-objects option)
pip install pyodbc
```

### For Docker Environments

If you're using a dev container, pyodbc may already be installed. To verify:

```bash
python3 -c "import pyodbc; print('pyodbc available')"
```

## Usage

### Basic Usage (No Database Connection)

Adds schema creation and schemaName attributes:

```bash
python3 scripts/fix-liquibase-baseline.py \
  --baseline-file /path/to/V0000__baseline.xml \
  --schema app
```

### Full Fix (With Database Objects)

Connects to database to extract stored procedures and functions:

```bash
python3 scripts/fix-liquibase-baseline.py \
  --baseline-file /data/liquibase/database/changelog/baseline/V0000__baseline.xml \
  --schema app \
  --add-db-objects \
  --server localhost \
  --port 1433 \
  --database testdb \
  --username sa \
  --password 'YourStrong!Passw0rd'
```

### With Backup

Create a backup before modifying:

```bash
python3 scripts/fix-liquibase-baseline.py \
  --baseline-file /data/liquibase/database/changelog/baseline/V0000__baseline.xml \
  --schema app \
  --add-db-objects \
  --database testdb \
  --password 'YourStrong!Passw0rd' \
  --backup
```

### Custom Output File

Write to a different file instead of overwriting:

```bash
python3 scripts/fix-liquibase-baseline.py \
  --baseline-file V0000__baseline.xml \
  --schema app \
  --output V0000__baseline_fixed.xml
```

## Command-Line Options

| Option | Required | Default | Description |
|--------|----------|---------|-------------|
| `--baseline-file` | Yes | - | Path to the baseline XML file to fix |
| `--schema` | No | `app` | Schema name to use |
| `--add-db-objects` | No | `False` | Connect to database and extract stored procedures/functions |
| `--server` | No | `localhost` | SQL Server hostname |
| `--port` | No | `1433` | SQL Server port |
| `--database` | No | `testdb` | Database name |
| `--username` | No | `sa` | Database username |
| `--password` | Conditional | - | Database password (required with `--add-db-objects`) |
| `--output` | No | (overwrites input) | Output file path |
| `--backup` | No | `False` | Create backup of original file |

## Examples

### Example 1: Fix Baseline from Dev Container

```bash
# In your dev container where SQL Server is running
cd /data/liquibase

# Generate baseline
docker run --rm --network=host \
  -v /data/liquibase:/workspace \
  liquibase-custom:5.0.1 \
  --url="jdbc:sqlserver://localhost:1433;databaseName=testdb;encrypt=true;trustServerCertificate=true" \
  --username="sa" \
  --password='YourStrong!Passw0rd' \
  --changelog-file=/workspace/database/changelog/baseline/V0000__baseline.xml \
  --schemas=app \
  generateChangeLog

# Fix the generated baseline
python3 /workspaces/dbtools/scripts/fix-liquibase-baseline.py \
  --baseline-file database/changelog/baseline/V0000__baseline.xml \
  --schema app \
  --add-db-objects \
  --password 'YourStrong!Passw0rd' \
  --backup
```

### Example 2: Fix Without Database Access

If you don't have database access or just want to add schema attributes:

```bash
python3 scripts/fix-liquibase-baseline.py \
  --baseline-file V0000__baseline.xml \
  --schema myschema \
  --backup
```

### Example 3: Multiple Schemas

Fix baseline for a different schema:

```bash
python3 scripts/fix-liquibase-baseline.py \
  --baseline-file V0000__sales_baseline.xml \
  --schema sales \
  --add-db-objects \
  --database mydb \
  --password 'YourStrong!Passw0rd'
```

## Output

The script provides progress information:

```
Processing: /data/liquibase/database/changelog/baseline/V0000__baseline.xml
✓ Created backup: /data/liquibase/database/changelog/baseline/V0000__baseline.xml.bak
  • Adding schemaName attributes...
  • Adding schema creation changeset for 'app'...
Connecting to localhost:1433/testdb...
  • Adding stored procedures and functions...
    ✓ Added 3 stored procedure(s)
    ✓ Added 2 function(s)
✓ Fixed baseline written to: /data/liquibase/database/changelog/baseline/V0000__baseline.xml

✓ Done! Review the fixed baseline file before using it.
```

## Limitations

- Only works with SQL Server databases
- Requires XML format changelogs (not YAML or SQL)
- Stored procedures and functions extraction requires database connection and pyodbc
- Doesn't modify changeset IDs (keeps generated timestamps)
- Doesn't handle triggers (these need manual addition)

## Troubleshooting

### "pyodbc not available"

```bash
pip install pyodbc
```

### "Error connecting to database"

Check your connection parameters:

- Server is accessible
- Port is correct (1433 is default)
- Username/password are correct
- Database exists

### "Permission denied"

Make sure the script is executable:

```bash
chmod +x scripts/fix-liquibase-baseline.py
```

## Integration with Liquibase Workflow

Recommended workflow:

1. **Generate baseline** using Liquibase:

   ```bash
   liquibase generateChangeLog --schemas=app
   ```

2. **Fix baseline** using this script:

   ```bash
   python3 scripts/fix-liquibase-baseline.py \
     --baseline-file V0000__baseline.xml \
     --schema app \
     --add-db-objects \
     --password 'xxx' \
     --backup
   ```

3. **Review** the fixed baseline file

4. **Sync to source database**:

   ```bash
   liquibase changelogSync
   ```

5. **Deploy to target databases**:

   ```bash
   liquibase update
   ```

## See Also

- [SQL Server Liquibase Tutorial](../docs/tutorials/liquibase/sqlserver-liquibase-tutorial.md)
- [Liquibase Documentation](https://docs.liquibase.com/)
